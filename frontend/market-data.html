<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BondVault - Public Market Data Filings</title>
    <meta name="description" content="Search and filter real-time Indian bond market data. Access ISINs, credit ratings, and coupon rates from SEBI and NSE filings.">
    
    <!-- SECURITY: Content Security Policy (CSP) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src https://cdnjs.cloudflare.com; connect-src 'self' https://*.onrender.com http://127.0.0.1:5000;">
    <!-- SPEED: Preconnect to CDNs -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <style>
        /* --- CSS Reset and Base Styles --- */
        /* MONETIZATION: Ad Slot Styles to prevent CLS (Cumulative Layout Shift) */
        .ad-slot {
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            margin: 20px 0;
        }
        .ad-banner { width: 100%; height: 90px; } /* Standard Leaderboard */
        .ad-sidebar { width: 300px; height: 250px; } /* Standard MPU */

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background-color: #f7f7f7; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px 15px; }
        a { text-decoration: none; color: inherit; }

        /* --- Header and Navigation Styles --- */
        .main-header { display: flex; justify-content: space-between; align-items: center; background-color: #007f3f; color: white; padding: 10px 15px; flex-wrap: wrap; }
        .logo-nav-container { display: flex; align-items: center; }
        .logo { font-size: 1.5em; font-weight: bold; padding-right: 20px; white-space: nowrap; }
        .main-nav ul { list-style: none; display: flex; padding: 0; }
        .main-nav li { padding: 0 10px; }
        .main-nav a { 
            color: white; 
            padding: 5px 10px; 
            position: relative; 
            display: block; 
            border-radius: 5px; 
        }
        .contact-btn { background-color: white; color: #007f3f; padding: 5px 12px; border-radius: 5px; font-weight: bold; font-size: 0.9em; }
        .main-nav a.active-link { 
            background-color: white; 
            color: #007f3f !important; 
        }

        /* --- Button and Search Styles --- */
        .explore-btn { display: inline-block; background-color: #007f3f; color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; margin-top: 10px; margin-bottom: 30px; transition: background-color 0.3s; cursor: pointer; border: none; }
        .explore-btn:hover { background-color: #006432; }
        .search-box { display: flex; border: 1px solid #ccc; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
        .search-box input[type="text"] { flex-grow: 1; border: none; padding: 10px 15px; font-size: 1em; outline: none; }
        .search-btn { background-color: #007f3f; color: white; border: none; padding: 10px 15px; cursor: pointer; font-size: 1.1em; }
        /* NEW: Market Data Button after search bar */
        .search-action-btn { background-color: #f7f7f7; color: #007f3f; border: 2px solid #007f3f; padding: 10px 20px; border-radius: 5px; font-weight: bold; display: block; width: 100%; margin-bottom: 30px; cursor: pointer; transition: all 0.2s;}
        .search-action-btn:hover { background-color: #007f3f; color: white; }


        /* --- BOND CARD NEW STYLES (BIGGER CARDS) --- */
        .detailed-bond-card {
            background-color: white;
            border: 1px solid #ddd;
            border-left: 5px solid #007f3f;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }

        .detailed-bond-card h3 {
            font-size: 1.3em;
            font-weight: bold;
            color: #007f3f;
            margin: 0;
        }

        .bond-attributes {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .bond-attribute {
            font-size: 0.9em;
            background-color: #e6ffe6;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            color: #333;
        }

        .bond-attribute span {
            font-weight: normal;
            color: #555;
            display: block;
            margin-top: 2px;
            font-size: 0.9em;
        }

        .view-more-btn {
            background-color: #f0f0f0;
            color: #007f3f;
            padding: 8px 15px;
            border: 1px solid #007f3f;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            align-self: flex-start;
            transition: background-color 0.2s;
        }

        .view-more-btn:hover {
            background-color: #007f3f;
            color: white;
        }


        /* --- Explore Page Layout & Legal Banner --- */
        .explore-layout { display: flex; gap: 20px; margin-top: 20px; }
        .bond-listings { flex-grow: 1; }
        .legal-banner { background-color: #ffe0b2; border: 2px solid #ff9800; color: #333; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .filter-group { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed #eee; }
        .filter-group label { display: block; font-size: 0.9em; margin-bottom: 5px; cursor: pointer; }
        .filter-group input[type="checkbox"] { margin-right: 8px; accent-color: #007f3f; }
        #bonds-container { display: grid; gap: 15px; grid-template-columns: 1fr; }
        
        /* --- Regulatory Disclaimer Footer --- */
        .site-footer { background-color: #222; color: #fff; padding: 25px 0; font-size: 0.9em; text-align: center; margin-top: 40px; border-top: 4px solid #007f3f; }
        .site-footer a { color: #7affc8; }
        .site-footer p { margin-bottom: 10px; }

        /* --- Global Modal Styles (Contact Modal & Details Modal) --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content h2 { color: #007f3f; margin-bottom: 15px; }
        .modal-content label { display: block; margin-top: 10px; font-weight: bold; }
        .modal-content input:not([type="checkbox"]), .modal-content textarea { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-content .explore-btn { width: 100%; text-align: center; }
        .modal-content .legal-check { font-size: 0.9em; margin-top: 10px; margin-bottom: 15px; }
        .modal-content input[type="checkbox"] { display: inline-block; width: auto; margin-right: 5px; }
        /* Add styles for the details modal content specifically */
        .details-modal-body p { margin-bottom: 10px; }
        .details-modal-body .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #eee;
        }
        .details-modal-body .detail-label {
            font-weight: bold;
            color: #555;
        }
        .details-modal-body .detail-value {
            color: #007f3f;
            font-weight: bold;
        }
        .no-results {
            padding: 20px;
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 5px;
            text-align: center;
            color: #c0392b;
            font-weight: bold;
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            .explore-layout { flex-direction: column; }
            .search-box { margin-top: 10px; }
            .detailed-bond-card { margin-bottom: 15px; }
            .main-header { flex-direction: column; align-items: flex-start; }
            .main-nav ul { flex-wrap: wrap; margin-top: 10px; }
            .main-nav li { padding: 0 10px 0 0; }
            .contact-btn { margin-top: 10px; display: inline-block; }
            .logo-nav-container { flex-direction: column; align-items: flex-start; width: 100%; }
        }

        /* --- Cookie Consent --- */
        #cookie-banner { position: fixed; bottom: 0; left: 0; width: 100%; background: #333; color: white; padding: 15px; text-align: center; z-index: 2000; display: none; }
        #cookie-banner button { background: #007f3f; color: white; border: none; padding: 5px 15px; margin-left: 10px; cursor: pointer; border-radius: 3px; }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- ANALYTICS: Google Analytics 4 (Placeholder) -->
    <!-- 
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script> 
    -->
</head>
<body>

    <header class="main-header">
        <div class="logo-nav-container">
            <div class="logo">BondVault</div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="market-data.html" class="active-link">Market Data</a></li>
                    <li><a href="learning.html">Learning</a></li>
                </ul>
            </nav>
        </div>
        <a href="#" class="contact-btn" id="openContactModal">Contact Us</a>
    </header>

    <main class="container">
        
        <div class="legal-banner">
            <h2>⚠️ Warning: Not Investment Advice or Facilitation</h2>
            <p>BondVault.in is a technology platform for educational purposes only and is NOT a SEBI-registered Investment Advisor, Research Analyst, or Broking entity. We do not provide investment advice or bond recommendations. All data is pulled from public sources (SEBI/Exchanges) and provided "as is" without any warranty of accuracy. BondVault.in shall not be liable for any financial losses. Past performance of bonds is not indicative of future results.</p>
        </div>

        <h1>Search Public Market Data</h1>
        <p>Filter by factual issuer and regulatory characteristics only.</p>

        <!-- TRUST SIGNAL: Data Latency & Source Indicator -->
        <div style="background: #e8f4f8; color: #005580; padding: 10px 15px; border-radius: 4px; font-size: 0.85em; margin-bottom: 20px; border-left: 4px solid #0077cc; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-clock"></i> 
            <span><strong>Data Status:</strong> Delayed (End of Day). Sourced from public filings (SEBI/Exchanges). <span id="data-timestamp"></span></span>
        </div>

        <!-- MONETIZATION: Top Leaderboard Ad Slot -->
        <div class="ad-slot ad-banner">Advertisement Space (Leaderboard)</div>

        <div class="explore-layout">

            <section class="bond-listings">
                
                <div class="search-section">
                    <div class="search-box">
                        <input type="text" id="bonds-search" placeholder="Search by Issuer, ISIN, Rating, or Instrument Type..." autocomplete="off">
                        <button type="submit" class="search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                </div>

                <div id="bonds-container">
                    <!-- Initial State: Empty with instruction -->
                    <div class="no-results" style="background: white; padding: 40px; color: #666; border: 1px dashed #ccc;">
                        <i class="fas fa-search" style="font-size: 2em; margin-bottom: 15px; color: #007f3f;"></i><br>
                        Please use the <strong>Search Bar</strong> to view market data.
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div id="pagination-controls" style="display: none; justify-content: center; gap: 15px; margin-top: 30px; align-items: center;">
                    <button id="prevBtn" class="explore-btn" style="margin: 0; padding: 8px 20px; background-color: #ccc;" onclick="changePage(-1)" disabled>&lt; Prev</button>
                    <span id="pageIndicator" style="font-weight: bold; color: #333;">Page 1</span>
                    <button id="nextBtn" class="explore-btn" style="margin: 0; padding: 8px 20px;" onclick="changePage(1)">Next &gt;</button>
                </div>

                <!-- MONETIZATION: In-Feed Ad Slot -->
                <div class="ad-slot ad-banner" style="margin-top: 40px;">Advertisement Space (In-Feed)</div>

            </section>
        </div>
    </main>

    <!-- RISK MITIGATION: Mandatory Acknowledgment Modal -->
    <div id="riskModal" class="modal" style="z-index: 3000;">
        <div class="modal-content" style="border-top: 5px solid #d35400; max-width: 600px;">
            <h2 style="color: #d35400; border-bottom: 1px solid #eee; padding-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Risk Disclosure & Waiver</h2>
            <p><strong>Attention User:</strong> You are accessing a database of fixed-income securities. Before proceeding, you must acknowledge the following:</p>
            <ul style="margin: 15px 0; padding-left: 20px; color: #555; line-height: 1.6;">
                <li><strong>No Investment Advice:</strong> BondVault is an educational aggregator. We do not recommend buying or selling any security.</li>
                <li><strong>Data Accuracy:</strong> Data is sourced from public filings and may be delayed or contain errors. Verify with official exchange filings.</li>
                <li><strong>Investment Risk:</strong> Corporate bonds carry credit risk, liquidity risk, and interest rate risk. Capital loss is possible.</li>
            </ul>
            <div style="background: #fff3e0; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #5d4037; margin-bottom: 15px;">
                By clicking "I Acknowledge", you confirm that you have read and understood the <a href="terms.html" target="_blank" style="text-decoration: underline; font-weight: bold;">Terms of Use</a> and <a href="terms.html#risk" target="_blank" style="text-decoration: underline; font-weight: bold;">Risk Disclosure Statement</a>.
            </div>
            <button id="acceptRiskBtn" class="explore-btn" style="width: 100%; background-color: #d35400; margin-top: 0;">I Acknowledge & Proceed</button>
        </div>
    </div>

    <footer class="site-footer">
        <div class="container">
            <p><strong>Disclaimer:</strong> BondVault.in is a technology platform for educational purposes only and is NOT a SEBI-registered Investment Advisor, Research Analyst, or Broking entity. We do not provide investment advice or bond recommendations. All data is pulled from public sources (SEBI/Exchanges) and provided "as is" without any warranty of accuracy. BondVault.in shall not be liable for any financial losses. Past performance of bonds is not indicative of future results.</p>
            <p style="font-weight: bold; color: #fff; margin-top: 10px; border: 1px solid #fff; padding: 10px; display: inline-block;">Investment in securities market are subject to market risks. Read all the related documents carefully before investing.</p>
            <p style="margin-top: 5px;"><a href="terms.html">Terms of Use</a> | <a href="privacy.html">Privacy Policy</a></p>
            <p style="margin-top: 15px;">&copy; 2025 BondVault.</p>
        </div>
    </footer>
    
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Get in Touch</h2>
            <p>Please enter your details and we'll get back to you shortly.</p>
            <form id="contactForm">
                <label for="name">Name</label>
                <input type="text" id="name" name="name" required>
                
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required>

                <label for="mobile">Mobile Number</label>
                <input type="tel" id="mobile" name="mobile" placeholder="+91 98765 43210">

                <label for="message">Your Message</label>
                <textarea id="message" name="message" rows="4" required></textarea>
                
                <div class="legal-check">
                    <input type="checkbox" id="legalCheck" required>
                    <label for="legalCheck">I confirm I have read and agree to the <a href="terms.html" target="_blank" rel="noopener noreferrer">Terms of Use</a> and <a href="privacy.html" target="_blank" rel="noopener noreferrer">Privacy Policy</a>.</label>
                </div>
                
                <button type="submit" class="explore-btn">Send Message</button>
            </form>
        </div>
    </div>
    
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn details-close-btn">&times;</span>
            <h2 id="detailsModalTitle">Bond Details</h2>
            <div class="details-modal-body">
                </div>
            <p style="margin-top: 15px; font-size: 0.8em; color: #888; text-align: center; border-top: 1px solid #eee; padding-top: 10px;"><em>Disclaimer: Data for educational use only. Not investment advice.</em></p>
        </div>
    </div>

    <div id="cookie-banner">
        <p style="display:inline; font-size: 0.9em;">We use cookies to improve your experience. By using BondVault, you agree to our <a href="privacy.html" style="text-decoration: underline;">Privacy Policy</a>.</p>
        <button onclick="acceptCookies()">Accept</button>
    </div>

    <!-- Inline Script to handle Data Fetching and Modal Rendering -->
    <script>
        // CONFIGURATION: Backend URL
        // If your Render app has a different name, update the URL below.
        const API_BASE = (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost" || window.location.protocol === "file:")
            ? "http://127.0.0.1:5000" : "https://bondvault-api.onrender.com";
        let allBonds = [];
        let initialLoad = true;
        let currentPage = 1;
        const itemsPerPage = 50;

        // Cookie Consent Logic
        if(!localStorage.getItem('bv_cookies_accepted')) {
            document.getElementById('cookie-banner').style.display = 'block';
        }
        function acceptCookies() {
            localStorage.setItem('bv_cookies_accepted', 'true');
            document.getElementById('cookie-banner').style.display = 'none';
        }

        // Set Data Timestamp (Trust Signal)
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById('data-timestamp').innerText = yesterday.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });

        // Risk Modal Logic
        document.addEventListener('DOMContentLoaded', async () => {
            if (!localStorage.getItem('bv_risk_acknowledged')) {
                const modal = document.getElementById('riskModal');
                if (modal) modal.style.display = 'block';
            }
            // ARCHITECTURE: Restore state from URL (Deep Linking)
            await restoreStateFromUrl();
        });

        document.getElementById('acceptRiskBtn').addEventListener('click', () => {
            localStorage.setItem('bv_risk_acknowledged', 'true');
            document.getElementById('riskModal').style.display = 'none';
        });

        function escapeHtml(text) {
            if (text == null) return '';
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function renderBonds(data) {
            const container = document.getElementById('bonds-container');
            if (data.length === 0) {
                document.getElementById('pagination-controls').style.display = 'none';
                container.innerHTML = '<div class="no-results">No bonds found matching your criteria.</div>';
                return;
            }
            
            container.innerHTML = data.map(bond => `
                <div class="detailed-bond-card" itemscope itemtype="https://schema.org/FinancialProduct">
                    <div class="card-header">
                        <h3 itemprop="name">${escapeHtml(bond.issuer_name || 'Unknown Issuer')} <span style="font-size:0.7em; font-weight:normal; color:#666; background:#f0f0f0; padding:2px 6px; border-radius:4px; margin-left:5px;">${escapeHtml(bond.issuer_ownership_type || 'N/A')} | ${escapeHtml(bond.instrument_type || 'Bond')}</span></h3>
                        <span style="font-size: 0.8em; color: #666;"><span itemprop="productID">${escapeHtml(bond.isin)}</span> <i class="fas fa-copy" role="button" tabindex="0" style="cursor:pointer; margin-left:5px; color:#007f3f;" onclick="copyToClipboard('${escapeHtml(bond.isin)}')" onkeydown="if(event.key==='Enter'){copyToClipboard('${escapeHtml(bond.isin)}')}" title="Copy ISIN" aria-label="Copy ISIN to clipboard"></i></span>
                    </div>
                    <div class="bond-attributes">
                        <meta itemprop="issuer" content="${escapeHtml(bond.issuer_name)}">
                        <div class="bond-attribute">Credit Rating <span>${escapeHtml(bond.credit_rating || '-')}</span></div>
                        <div class="bond-attribute">Coupon Rate <span itemprop="interestRate">${escapeHtml(bond.coupon_rate_pct || '-')}</span></div>
                        <div class="bond-attribute">Date of Allotment <span itemprop="releaseDate">${escapeHtml(bond.allotment_date || '-')}</span></div>
                        <div class="bond-attribute">Date of Redemption <span>${escapeHtml(bond.redemption_date || '-')}</span></div>
                        <div class="bond-attribute">Face Value <span>${escapeHtml(bond.face_value_inr || '-')}</span></div>
                        <div class="bond-attribute">Issue Size <span>${escapeHtml(bond.issue_size_inr || '-')}</span></div>
                    </div>
                    <button class="view-more-btn" onclick="openDetailsModal('${bond.id}')">View Details</button>
                </div>
            `).join('');

            updatePaginationUI(data.length);
        }

        // Unified Fetch Logic
        async function fetchMarketData(resetPage = false) {
            if (resetPage) currentPage = 1;

            const container = document.getElementById('bonds-container');
            const query = document.getElementById('bonds-search').value.toLowerCase().trim();

            // SEO: Update URL with search query
            if (!initialLoad) updateUrlState({ search: query, page: currentPage });

            if (!query) {
                container.innerHTML = '<div class="no-results" style="background: white; padding: 40px; color: #666; border: 1px dashed #ccc;"><i class="fas fa-search" style="font-size: 2em; margin-bottom: 15px; color: #007f3f;"></i><br>Please use the <strong>Search Bar</strong> to view market data.</div>';
                document.getElementById('pagination-controls').style.display = 'none';
                return;
            }

            container.innerHTML = '<p style="text-align:center; padding:40px; color:#666;"><i class="fas fa-spinner fa-spin"></i> Searching Vault...</p>';

            // Build URL
            let url = `${API_BASE}/api/bonds?limit=${itemsPerPage}&page=${currentPage}`;
            url += `&search=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Failed to fetch");
                allBonds = await response.json();
                renderBonds(allBonds);

                // ARCHITECTURE: If URL has a bondId, open it now that data is loaded
                const params = new URLSearchParams(window.location.search);
                if (initialLoad && params.get('bondId')) {
                    openDetailsModal(params.get('bondId'));
                }
                initialLoad = false;
            } catch (e) {
                container.innerHTML = `<div class="no-results">Error loading market data. Please ensure backend is running.</div>`;
            }
        }

        function updatePaginationUI(count) {
            const controls = document.getElementById('pagination-controls');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const indicator = document.getElementById('pageIndicator');

            controls.style.display = 'flex';
            indicator.innerText = `Page ${currentPage}`;

            // Prev Button Logic
            prevBtn.disabled = (currentPage === 1);
            prevBtn.style.backgroundColor = (currentPage === 1) ? '#ccc' : '#666';

            // Next Button Logic (If we received fewer items than the limit, we are at the end)
            const hasNext = count === itemsPerPage;
            nextBtn.disabled = !hasNext;
            nextBtn.style.backgroundColor = !hasNext ? '#ccc' : '#007f3f';
        }

        function changePage(delta) {
            currentPage += delta;
            fetchMarketData(false);
            document.getElementById('bonds-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // UTILITY: Debounce function for efficient automatic search
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Event Listeners
        document.querySelector('.search-btn').addEventListener('click', (e) => {
            e.preventDefault(); // Prevent form submission if applicable
            fetchMarketData(true);
        });
        
        const searchInput = document.getElementById('bonds-search');
        // Auto-search when typing (Debounced to 300ms for snappier feel)
        searchInput.addEventListener('input', debounce(() => fetchMarketData(true), 300));
        searchInput.addEventListener('keyup', (e) => {
            if(e.key === 'Enter') fetchMarketData(true);
        });

        // Modal Logic
        const modal = document.getElementById('detailsModal');
        const closeBtn = document.querySelector('.details-close-btn');
        
        closeBtn.onclick = () => closeModal();
        window.onclick = (event) => { 
            if (event.target == modal) closeModal();
            
            // Risk Modal Blocking: Do not close if clicking outside
            const riskModal = document.getElementById('riskModal');
            if (event.target == riskModal && riskModal.style.display === 'block') return;
        };

        function closeModal() {
            modal.style.display = "none";
            document.title = "BondVault - Public Market Data Filings";
            // Remove bondId from URL but keep search
            const params = new URLSearchParams(window.location.search);
            params.delete('bondId');
            const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            window.history.pushState({}, '', newUrl);
        }

        function openDetailsModal(id) {
            const bond = allBonds.find(b => b.id === id);
            if (!bond) return;

            // SEO: Update URL and Title
            updateUrlState({ bondId: id });
            document.title = `${bond.issuer_name} (${bond.coupon_rate_pct}) - BondVault`;

            const fields = [
                { label: "Issuer Name", key: "issuer_name" },
                { label: "Issuer Ownership", key: "issuer_ownership_type" },
                { label: "Type of Instrument", key: "instrument_type" },
                { label: "Credit Rating", key: "credit_rating" },
                { label: "Coupon Rate", key: "coupon_rate_pct" },
                { label: "Coupon Type", key: "coupon_type" },
                { label: "Payment Frequency", key: "payment_frequency" },
                { label: "Tenor", key: "tenor" },
                { label: "Date of Redemption", key: "redemption_date" },
                { label: "Face Value (INR)", key: "face_value_inr" },
                { label: "ISIN", key: "isin" },
                { label: "Mode of Issuance", key: "issuance_mode" },
                { label: "Category of Issue", key: "issue_category" },
                { label: "Issue Size (INR)", key: "issue_size_inr" },
                { label: "Date of Allotment", key: "allotment_date" }
            ];

            const modalBody = document.querySelector('.details-modal-body');
            modalBody.innerHTML = fields.map(f => {
                // Handle Blank Data: Check if value exists, is not null, and not empty string. Else show "N/A" or "-"
                let val = bond[f.key];
                if (val === null || val === undefined || val === "") {
                    val = "N/A"; // Or "-" as preferred
                }
                
                let copyBtn = "";
                if (f.key === "isin" && val !== "N/A") {
                    copyBtn = ` <i class="fas fa-copy" role="button" tabindex="0" style="cursor:pointer; margin-left:10px; color:#007f3f;" onclick="copyToClipboard('${val}')" onkeydown="if(event.key==='Enter'){copyToClipboard('${val}')}" title="Copy ISIN" aria-label="Copy ISIN"></i>`;
                }

                return `
                    <div class="detail-row">
                        <span class="detail-label">${escapeHtml(f.label)}</span>
                        <span class="detail-value">${escapeHtml(val)}${copyBtn}</span>
                    </div>
                `;
            }).join('');

            modal.style.display = "block";
        }

        // ARCHITECTURE: URL State Management Functions
        function updateUrlState(params) {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (params.search !== undefined) {
                if (params.search) urlParams.set('search', params.search);
                else urlParams.delete('search');
            }
            if (params.page !== undefined) urlParams.set('page', params.page);
            if (params.bondId !== undefined) urlParams.set('bondId', params.bondId);

            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.pushState({}, '', newUrl);
        }

        async function restoreStateFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const search = params.get('search');
            const page = params.get('page');
            
            if (search) {
                document.getElementById('bonds-search').value = search;
                if (page) currentPage = parseInt(page);
                await fetchMarketData(false); // Fetch will handle opening modal if bondId exists
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("ISIN copied to clipboard: " + text);
            });
        }

        // Initialize Contact Modal
        setupContactModal();

        function setupContactModal() {
            const modal = document.getElementById("contactModal");
            const openBtn = document.getElementById("openContactModal");
            const closeBtn = document.querySelector("#contactModal .close-btn");
            const contactForm = document.getElementById("contactForm");
            const legalCheckbox = document.getElementById('legalCheck');

            if (modal && openBtn && closeBtn && contactForm) {
                openBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    modal.style.display = "block";
                });
                
                closeBtn.addEventListener('click', () => modal.style.display = "none");
                
                window.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = "none";
                });
                
                contactForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (legalCheckbox && !legalCheckbox.checked) {
                        alert('You must agree to the Terms of Use.');
                        return;
                    }
                    
                    const formData = {
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value,
                        mobile: document.getElementById('mobile').value,
                        message: document.getElementById('message').value
                    };

                    try {
                        const response = await fetch(`${API_BASE}/api/contact`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        
                        if(response.ok) {
                            alert('Message sent successfully! We will contact you shortly.'); 
                            contactForm.reset(); 
                            modal.style.display = "none";
                        } else {
                            alert('Failed to send message. Please try again.');
                        }
                    } catch (error) {
                        console.error(error);
                        alert('System Offline. Please try again later.');
                    }
                });
            }
        }
    </script>
</body>
</html>
